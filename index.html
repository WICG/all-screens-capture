<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
  <title>Capture all screens</title>
  <script src="https://www.w3.org/Tools/respec/respec-w3c" class="remove"></script>
  <script class="remove">
    const respecConfig = {
      group: "wicg",
      specStatus: "CG-DRAFT",
      github: {
        repoURL: "https://github.com/wicg/multicapture/",
        branch: "master",
      },
      editors: [
        {
          name: "Simon Hangl",
          email: "simonha@google.com",
          company: "Google",
        },
        {
          name: "Elad Alon",
          email: "eladalon@google.com",
          company: "Google",
        },
      ],
      xref: ["html", "infra", "permissions", "permissions-policy", "dom", "mediacapture-streams", "webidl", "screen-capture"],
      shortName: "capture-all-screens",
      subjectPrefix: "[capture-all-screens]",
    };
  </script>
</head>

<body>
  <section id="abstract">
    <h2>Abstract</h2>
    <p>
      This document defines a new API {{MediaDevices/getAllScreenMedia}}
      for capturing multiple
      <a data-cite="screen-capture#dfn-display-surface">display surfaces</a>
      following one user gesture.
      It is an extension to the Screen Capture API [[screen-capture]].
    </p>
  </section>
  <section id="sotd">
    <p>
      This document is a draft. It is subject to major changes and, while early
      experimentations are encouraged, it is therefore not intended for implementation.
    </p>
  </section>
  <section class="informative" id="introduction">
    <h2>
      Introduction
    </h2>
    <p>
      The Screen Capture API [[screen-capture]] enables the capturing of a single
      <a data-cite="screen-capture#dfn-display-surface">display surface</a> in the
      form of a video track.
    </p>
    <p>

      Users currently cannot capture multiple
      <a data-cite="screen-capture#dfn-monitor">monitors</a>
      at once without a [=transient activation=]. This may be useful in certain
      scenarios, e.g. for compliance or training purposes.
      The only currently available alternative is through the Screen Capture API with
      <a data-cite="screen-capture#dom-mediadevices-getdisplaymedia">getDisplayMedia</a>
      by calling
      <a data-cite="screen-capture#dom-mediadevices-getdisplaymedia">getDisplayMedia</a>
      several times and asking the user to select the available
      <a data-cite="screen-capture#dfn-monitor">monitors</a>.
      This requires multiple user gestures, repeated interaction with browser-level UX.
      This adds unnecessary friction and results in degraded user experience and
      interrupted workflows.
    </p>
    <p>
      This document describes {{MediaDevices/getAllScreenMedia}}, an extension to
      the Screen Capture API [[screen-capture]].
      {{MediaDevices/getAllScreenMedia}} enables
      the capturing of several of the user's <a data-cite="screen-capture#dfn-monitor">monitors</a>,
      or parts thereof, without a [=transient activation=].
      It returns a list of media streams
      (each containing a track corresponding to the captured
      <a data-cite="screen-capture#dfn-monitor">monitor</a>).
      As no [=transient activation=] is required, the <a href="#dfn-user-agent">user agent</a>
      MUST ensure that appropriate protection, e.g. by allowlisting permitted
      <a data-cite="url#concept-url-origin">origin</a>.
    </p>
  </section>
  <section id="conformance">
    <p>
      This specification defines conformance criteria that apply to a single product: the
      <dfn data-lt="user-agent">user agent</dfn> that implements the interfaces that it
      contains.
    </p>
    <p>
      Implementations that use ECMAScript [[ECMA-262]] to implement the APIs defined in this
      specification must implement them in a manner consistent with the ECMAScript Bindings
      defined in the Web IDL specification [[!WEBIDL]], as this specification uses that
      specification and terminology.
    </p>
  </section>
  <section>
    <h2>
      Example
    </h2>
    <p>
      The following example demonstrates a request for all
      <a data-cite="screen-capture#dfn-monitor">monitors</a>
      using the
      <code>navigator.mediaDevices.getAllScreenMedia</code>
      method defined in this document.
    </p>
    <pre class="example highlight">
      try {
        const mediaStreams = await navigator.mediaDevices.getAllScreenMedia();
        mediaStreams.forEach((mediaStream, index) => {
          videoElements[index].srcObject = mediaStream;
        })
      } catch (e) {
        console.log('Unable to acquire screen captures: ' + e);
      }
    </pre>
  </section>
  <section id="terminology">
    <h2>
      Terminology
    </h2>
    <p>
      This document uses the definition of {{MediaStream}}, {{MediaStreamTrack}}
      from [[!GETUSERMEDIA]], <a data-cite="url#concept-url-origin">origin</a> from [[!url]],
      {{ScreenDetailed}} from [[!window-placement]],
      and <a data-cite="screen-capture#dfn-display-surface">monitor</a>
      from [[!screen-capture]].
    </p>
  </section>
  <section id="capture_multiple_display_surfaces">
    <h2>
      Capturing multiple monitors
    </h2>
    <p>
      Capture of all <a data-cite="screen-capture#dfn-monitor">monitors</a>
      is enabled through the addition of a new
      {{MediaDevices/getAllScreenMedia}} method on the {{MediaDevices}}
      interface.
    </p>
    <section>
      <h2>
        <dfn>MediaDevices</dfn> Additions
      </h2>
      <pre class="idl">
          partial interface MediaDevices {
            Promise&lt;sequence&lt;MediaStream&gt;&gt; getAllScreenMedia();
          };
        </pre>
      <dl data-link-for="MediaDevices" data-dfn-for="MediaDevices" class="methods">
        <dt>
          <dfn>getAllScreenMedia</dfn>
        </dt>
        <dd>
          <p>
            The <a href="#dfn-user-agent">user agent</a> MUST return a list of {{MediaStream}}
            objects, where each stream belongs to exactly one of the
            <a data-cite="screen-capture#dfn-monitor">monitors</a> attached to the device.
          </p>
          <p>
            {{PermissionState/"granted"}} permissions cannot be persisted.
          </p>
          <p>When the {{MediaDevices/getAllScreenMedia()}}
            method is called, the <a href="#dfn-user-agent">user agent</a> MUST run the following
            steps:</p>
          <ol>
            <li>
              <p>Let <var>p</var> be a new promise.</p>
            </li>
            <li>
              <p>Run the following steps in parallel:</p>
              <ol>
                <li>
                  <p>Optionally, e.g., for security reasons, or due to platform
                    limitations, jump to the step labeled <em>Permission Failure</em> below.</p>
                </li>
                <li>
                  <p>The <a href="#dfn-user-agent">user agent</a> MUST obtain permission
                  by appropriate means, e.g. by asking the user for permission or by
                  explicit allowlisting <a data-cite="url#concept-url-origin">origins</a> by an administrator.
                  </p>
                  <p>
                    Enumerate all <a data-cite="screen-capture#dfn-monitor">monitors</a>.
                    For each <a data-cite="screen-capture#dfn-monitor">monitor</a> create
                    a {{PermissionDescriptor}} with its {{PermissionDescriptor/name}} set
                    to "display-capture", resulting in a set of provided media.
                  </p>
                  <p>Each provided media MUST include precisely one video track.</p>
                  <p>Each provided media MUST not include any audio track.</p>
                  <p>The devices chosen MUST be the ones enumerated previously.
                    Once selected, the source of each {{MediaDevices/ScreenCaptureMediaStreamTrack}} MUST NOT change,
                    unless the user permits it through their interaction with
                    the <a href="#dfn-user-agent">user agent</a>.</p>
                  <p>If the result of the request is {{PermissionState/"granted"}}, then for
                    each device that is sourcing the provided medias, using
                    a stable and private id for the device, <var>deviceId</var>,
                    set [[\devicesLiveMap]]<var>[deviceId]</var> to
                    <code>true</code>, if it isn’t already <code>true</code>,
                    and set the
                    [[\devicesAccessibleMap]]<var>[deviceId]</var> to
                    <code>true</code>, if it isn’t already
                    <code>true</code>.
                  </p>
                  <p>
                    The <a href="#dfn-user-agent">user agent</a> MUST NOT store a {{PermissionState/"granted"}} permission entry.
                  </p>
                  <p>If the result is {{PermissionState/"denied"}}, jump to the step labeled
                    <em>Permission Failure</em> below.
                  </p>
                  <p>If the result of the request is {{PermissionState/"granted"}} but a hardware error
                    such as an OS/program/webpage lock prevents access to at least one device,
                    <a>reject</a> <var>p</var> with a new
                    {{DOMException}} object whose
                    {{DOMException/name}} attribute has the value
                    {{NotReadableError}} and abort these steps.
                  </p>
                  <p>If the result of the request is {{PermissionState/"granted"}} but device access fails for
                    any reason other than those listed above, <a>reject</a>
                    <var>p</var> with a new {{DOMException}}
                    object whose {{DOMException/name}} attribute has the
                    value {{AbortError}} and abort these steps.
                  </p>
                </li>
                <li>
                  <p>Let <var>streams</var> be the
                    list of {{MediaStream}} objects for which the permission was granted.</p>
                </li>
                <li>
                  <p><a>Resolve</a> <var>p</var> with <var>streams</var> and
                    abort these steps.</p>
                </li>
                <li>
                  <p><em>Permission Failure</em>: [=Reject=]
                    <var>p</var> with a new {{DOMException}}
                    object whose {{DOMException/name}} attribute has the
                    value {{NotAllowedError}}.
                  </p>
                </li>
              </ol>
            </li>
            <li>
              <p>Return <var>p</var>.</p>
            </li>
          </ol>
          <p>
            The <a href="#dfn-user-agent">user agent</a> MUST NOT capture content that's behind a
            partially transparent captured <a data-cite="screen-capture#dfn-display-surface">display surfaces</a>.
          </p>
          <p>
            For the newly created {{MediaDevices/ScreenCaptureMediaStreamTrack}}s, the <a>user agent</a> MUST NOT capture the
            prompt that was shown to the user.
          </p>
          <p>
            Information that is not currently rendered to the screen SHOULD be obscured in captures
            unless the application has been specifically authorized to access that content (e.g.
            through means such as
            <a data-cite="screen-capture#elevated-permissions">elevated permissions</a>).
          </p>
          <p>
            The <a href="#dfn-user-agent">user agent</a> MUST NOT share audio.
          </p>
        </dd>
      </dl>
    </section>

    <section>
      <h2>ScreenCaptureMediaStreamTrack</h2>
      {{MediaDevices/ScreenCaptureMediaStreamTrack}} extends {{MediaStreamTrack}} and
      corresponds to a <a data-cite="screen-capture#dfn-monitor">monitor</a>.
      It additionally provides a connection to the window placement API [[!window-placement]]
      with the {{MediaDevices/ScreenCaptureMediaStreamTrack/screenDetailed}} function with which metadata about the
      captured <a data-cite="screen-capture#dfn-monitor">monitor</a> can be retrieved.
      <pre class="idl">
        [Exposed=Window]
        interface ScreenCaptureMediaStreamTrack : MediaStreamTrack {
          ScreenDetailed screenDetailed();
        };
      </pre>
    </section>

    <section>
      <h2>Misc</h2>
      This specification extends the setions
      <a data-cite="screen-capture#hidden-display-surfaces">Closed and Minimized Display Surfaces</a>, and
      <a data-cite="screen-capture#deviceId">Device Identifiers</a>
      of {{MediaDevices/getDisplayMedia()}} to include {{MediaDevices/getAllScreenMedia()}}.
    </section>
  </section>
  <section id="permissionsintegration">
    <h2>
      Permissions Integration
    </h2>
    <p>
        As required for integration with the [[[Permissions]]] specification, this specification defines the following:
      </p>
      <dl>
        <dt>
          [=powerful feature/permission state constraints=]
        </dt>
        <dd>
          Valid values for this descriptor's <a>permission state</a> are
          {{PermissionState/"granted"}} and {{PermissionState/"denied"}}.
          The <a href="#dfn-user-agent">user agent</a> MAY
          set this descriptor's <a>permission state</a> to {{PermissionState/"granted"}}.
        </dd>
      </dl>
  </section>
  <section id="privacyindicatorsrequirements">
    <h2>
      Privacy Indicator Requirements
    </h2>
    <p>This specification extends the <a data-cite="screen-capture#privacy-indicator-requirements">
        Privacy Indicator Requirements</a> of
      {{MediaDevices/getDisplayMedia()}} to include {{MediaDevices/getAllScreenMedia()}}.</p>
  </section>
</body>

</html>